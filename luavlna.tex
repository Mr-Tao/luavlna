\input luatexbase.sty

% Modify pre_linebreak_filter callback so the spaces can be inserted
\directlua{%         
preventsingle = require "prevent-single" 
luatexbase.add_to_callback("pre_linebreak_filter", preventsingle.preventsingle," ")
% Process string and make table of enabled single letters
% By default, spaces for all single letters are inserted
% This can be modified with \singlechars macro
set_singlechars = function(lang,chars)
  local utf_gmatch = unicode.utf8.gmatch
  local chars = chars  or ""
  local singlechars = {}
  local percent = string.char(37)
  local alpha = percent .. "a"
  for char in utf_gmatch(chars,"("..alpha..")") do
    singlechars[char] = true
  end
  preventsingle.singlechars(lang,singlechars)
end
}     

% Set letters which are prevented from breaking
\def\singlechars#1#2{%
\directlua{set_singlechars("#1","#2")}
}

% Enable inserting of visual marks for debugging
\def\preventsingledebugon{%
\directlua{preventsingle.debug(true)}
}

% Disable inserting of visual marks for dewbugging
\def\preventsingledebugoff{%
\directlua{preventsingle.debug(false)}
}
\singlechars{16}{AIiVvOoUuSsZzKk}
